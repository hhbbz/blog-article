---
title: 从Dubbo浅谈RPC和HTTP
date: 2017-06-25 19:13:44
updated: 2017-06-27 11:21:34
categories: 
- 后端
tags:
- 分布式
---

# Dubbo协议

Dubbo是阿里集团开源的一个极为出名的RPC框架，在很多互联网公司和企业应用中广泛使用。协议和序列化框架都可以插拔是及其鲜明的特色。同样 的远程接口是基于Java Interface，并且依托于spring框架方便开发。可以方便的打包成单一文件，独立进程运行，和现在的微服务概念一致。

dubbo提供了多种协议，而协议本身不同有个几个指标

1. 连接个数：1 or n
2. 连接方式: 长连接 or 短连接
3. 传输协议：tcp or http
4. 传输方式： 同步 or nio异步
5. 序列化格式：hessian or Java二进制 or 类json表单序列化

好了，现在有了指标，你的需求按照这些指标来选择

- 你消费者和服务提供者 对比
- 传输数据大小
- 传输数据的格式
- 消费者和提供者 是否有防火墙
- 服务提供实现是 cpu密集型还是内存密集型.

# RPC架构

先说说RPC服务的基本架构吧。允许我可耻地盗一幅图哈~我们可以很清楚地看到，一个完整的RPC架构里面包含了四个核心的组件，分别是Client ,Server,Client Stub以及Server Stub，这个Stub大家可以理解为存根。分别说说这几个组件：

- 客户端（Client），服务的调用方。
- 服务端（Server），真正的服务提供者。
- 客户端存根，存放服务端的地址消息，再将客户端的请求参数打包成网络消息，然后通过网络远程发送给服务方。
- 服务端存根，接收客户端发送过来的消息，将消息解包，并调用本地的方法。

{% asset_img 1.jpg 图片 %}

RPC主要是用在大型企业里面，因为大型企业里面系统繁多，业务线复杂，而且效率优势非常重要的一块，这个时候RPC的优势就比较明显了。实际的开发当中是这么做的，项目一般使用maven来管理。比如我们有一个处理订单的系统服务，先声明它的所有的接口（这里就是具体指Java中的interface），然后将整个项目打包为一个jar包，服务端这边引入这个二方库，然后实现相应的功能，客户端这边也只需要引入这个二方库即可调用了。为什么这么做？主要是为了减少客户端这边的jar包大小，因为每一次打包发布的时候，jar包太多总是会影响效率。另外也是将客户端和服务端解耦，提高代码的可移植性。

# HTTP服务

其实在很久以前，我对于企业开发的模式一直定性为HTTP接口开发，也就是我们常说的RESTful风格的服务接口。的确，对于在接口不多、系统与系统交互较少的情况下，解决信息孤岛初期常使用的一种通信手段；优点就是简单、直接、开发方便。利用现成的http协议进行传输。我们记得之前本科实习在公司做后台开发的时候，主要就是进行接口的开发，还要写一大份接口文档，严格地标明输入输出是什么？说清楚每一个接口的请求方法，以及请求参数需要注意的事项等。比如下面这个例子：

POST http://www.httpexample.com/restful/buyer/info/share

接口可能返回一个JSON字符串或者是XML文档。然后客户端再去处理这个返回的信息，从而可以比较快速地进行开发。但是对于大型企业来说，内部子系统较多、接口非常多的情况下，RPC框架的好处就显示出来了，首先就是长链接，不必每次通信都要像http一样去3次握手什么的，减少了网络开销；其次就是RPC框架一般都有注册中心，有丰富的监控管理；发布、下线接口、动态扩展等，对调用方来说是无感知、统一化的操作。

# HTTP和RPC对比

- 一般HTTP协议的REST请求都需要穿过防火墙的，提供服务器调用可能是外网地址。
- 而RPC内网调用基本都是同机房内网ip，不需要防火墙，性能也会很好。
- REST都是消费者远远大于服务提供者的，都是数据量小的输入、输出参数。本地调用，可能用二进制的好点。 REST可能用类json表单序列化好点。
- 长连接使用HTTP而不是RPC
- 传输格式可以二进制
- Nio多路复用，支持并发会高很多
- 传统HTTP线程池实现，线程开销太大

# 总结

http是依赖于tcp的，http属于应用层。http协议自带默认的tcp报文协议，然而http1.1的报文协议解析效率过慢。而rpc框架是基于tcp协议的，相当于自定义了tcp的报文协议，提供者和消费者有统一的解析方式，且都是基于Netty去作为基础通信组件，用于实现各进程节点之间的内部通信，所以效率就起来了。

RPC服务和HTTP服务还是存在很多的不同点的，一般来说，RPC服务主要是针对大型企业的，而HTTP服务主要是针对小企业的，因为RPC效率更高，而HTTP服务开发迭代会更快。总之，选用什么样的框架不是按照市场上流行什么而决定的，而是要对整个项目进行完整地评估，从而在仔细比较两种开发框架对于整个项目的影响，最后再决定什么才是最适合这个项目的。一定不要为了使用RPC而每个项目都用RPC，而是要因地制宜，具体情况具体分析。

